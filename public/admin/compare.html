<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compare & Rank - Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <nav class="navbar">
    <div class="container navbar-content">
      <div class="navbar-brand">Risk Assessment Platform</div>
      <ul class="navbar-nav">
        <li><a href="/admin/dashboard.html" class="navbar-link">Dashboard</a></li>
        <li><a href="/admin/startup-users.html" class="navbar-link">Startup Users</a></li>
        <li><a href="/admin/submissions.html" class="navbar-link">Submissions</a></li>
        <li><a href="/admin/compare.html" class="navbar-link">Compare & Rank</a></li>
        <li><a href="/admin/survey-builder.html" class="navbar-link">Survey Builder</a></li>
        <li><span class="navbar-link" id="username-display"></span></li>
        <li><button class="btn btn-sm btn-secondary" id="logout-btn">Logout</button></li>
      </ul>
    </div>
  </nav>

  <div class="container mt-4">
    <h1>Compare & Rank Startups</h1>
    <p class="text-secondary">Visual comparison and ranking of startup risk assessments</p>

    <!-- Overall Risk Score Chart -->
    <div class="card mt-3 fade-in">
      <div class="card-header">
        <h3 class="card-title">üìä Overall Risk Score Comparison</h3>
      </div>
      <div class="card-body">
        <p class="text-secondary mb-3">Lower scores indicate lower risk (better investment candidates)</p>
        <canvas id="riskScoreChart" style="max-height: 400px;"></canvas>
      </div>
    </div>

    <!-- KPI Radar Chart -->
    <div class="card mt-4 fade-in">
      <div class="card-header">
        <h3 class="card-title">üéØ KPI Radar Comparison</h3>
      </div>
      <div class="card-body">
        <p class="text-secondary mb-3">Multi-dimensional view of key performance indicators</p>
        <canvas id="kpiRadarChart" style="max-height: 500px;"></canvas>
      </div>
    </div>

    <!-- Section Scores Comparison -->
    <div class="card mt-4 fade-in">
      <div class="card-header">
        <h3 class="card-title">üìà Section Risk Scores</h3>
      </div>
      <div class="card-body">
        <p class="text-secondary mb-3">Detailed breakdown by assessment section</p>
        <canvas id="sectionScoresChart" style="max-height: 500px;"></canvas>
      </div>
    </div>

    <!-- Ranking Table -->
    <div class="card mt-4 fade-in">
      <div class="card-header">
        <h3 class="card-title">üèÜ Ranking by Overall Risk Score</h3>
      </div>
      <div class="card-body">
        <div id="ranking-container">
          <div class="text-center" style="padding: 2rem;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p class="mt-2">Loading rankings...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI Table -->
    <div class="card mt-4 fade-in">
      <div class="card-header">
        <h3 class="card-title">üìã KPI Detailed Comparison</h3>
      </div>
      <div class="card-body">
        <div id="kpi-container">
          <p class="text-secondary">Loading KPI data...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let riskScoreChart, kpiRadarChart, sectionScoresChart;

    fetch('/admin/api/check-session')
      .then(res => res.json())
      .then(data => {
        if (!data.authenticated) {
          window.location.href = '/admin/login.html';
        } else {
          document.getElementById('username-display').textContent = data.username;
          loadRankings();
        }
      });

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await fetch('/admin/api/logout', { method: 'POST' });
      window.location.href = '/admin/login.html';
    });

    async function loadRankings() {
      try {
        const res = await fetch('/admin/api/submissions');
        const submissions = await res.json();

        // Sort by risk score (ascending - lower is better)
        submissions.sort((a, b) => a.total_risk_score - b.total_risk_score);

        displayRankings(submissions);
        displayKPIComparison(submissions);
        createRiskScoreChart(submissions);
        createKPIRadarChart(submissions);
        createSectionScoresChart(submissions);
      } catch (error) {
        document.getElementById('ranking-container').innerHTML =
          '<p class="text-center text-danger">Failed to load rankings</p>';
      }
    }

    function createRiskScoreChart(submissions) {
      const ctx = document.getElementById('riskScoreChart').getContext('2d');

      // Destroy existing chart if it exists
      if (riskScoreChart) riskScoreChart.destroy();

      const colors = submissions.map(sub => {
        if (sub.risk_band === 'Low Risk') return 'rgba(16, 185, 129, 0.8)';
        if (sub.risk_band === 'Medium Risk') return 'rgba(245, 158, 11, 0.8)';
        return 'rgba(239, 68, 68, 0.8)';
      });

      riskScoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: submissions.map(sub => sub.startup_name || sub.email),
          datasets: [{
            label: 'Overall Risk Score',
            data: submissions.map(sub => sub.total_risk_score),
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('0.8', '1')),
            borderWidth: 2,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const sub = submissions[context.dataIndex];
                  return [
                    `Risk Score: ${context.parsed.y.toFixed(2)}`,
                    `Risk Band: ${sub.risk_band}`,
                    `Decision: ${sub.decision}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Risk Score (Lower is Better)'
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    function createKPIRadarChart(submissions) {
      const ctx = document.getElementById('kpiRadarChart').getContext('2d');

      if (kpiRadarChart) kpiRadarChart.destroy();

      const kpiNames = {
        kpi_regulatory: 'Regulatory Risk',
        kpi_unit_economics: 'Unit Economics',
        kpi_growth_stability: 'Growth Stability',
        kpi_customer_concentration: 'Customer Concentration',
        kpi_execution_complexity: 'Execution Complexity',
        kpi_exit_clarity: 'Exit Clarity'
      };

      const colors = [
        'rgba(37, 99, 235, 0.6)',
        'rgba(139, 92, 246, 0.6)',
        'rgba(16, 185, 129, 0.6)',
        'rgba(245, 158, 11, 0.6)',
        'rgba(239, 68, 68, 0.6)',
        'rgba(236, 72, 153, 0.6)'
      ];

      const datasets = submissions.slice(0, 5).map((sub, index) => ({
        label: `#${index + 1} - ${sub.startup_name || sub.email}`,
        data: Object.keys(kpiNames).map(key => sub.kpi_scores[key] || 0),
        backgroundColor: colors[index],
        borderColor: colors[index].replace('0.6', '1'),
        borderWidth: 2,
        pointBackgroundColor: colors[index].replace('0.6', '1'),
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: colors[index].replace('0.6', '1')
      }));

      kpiRadarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: Object.values(kpiNames),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                title: function (context) {
                  const datasetIndex = context[0].datasetIndex;
                  const sub = submissions[datasetIndex];
                  return `#${datasetIndex + 1} - ${sub.startup_name || sub.email}`;
                },
                label: function (context) {
                  return `${context.label}: ${context.parsed.r.toFixed(1)}`;
                },
                afterLabel: function (context) {
                  const datasetIndex = context.datasetIndex;
                  const sub = submissions[datasetIndex];
                  return `Overall Risk Score: ${sub.total_risk_score.toFixed(1)}`;
                }
              }
            }
          },
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              ticks: {
                stepSize: 20
              }
            }
          }
        }
      });
    }

    function createSectionScoresChart(submissions) {
      const ctx = document.getElementById('sectionScoresChart').getContext('2d');

      if (sectionScoresChart) sectionScoresChart.destroy();

      const sectionNames = {
        'B': 'Offering & Product',
        'C': 'Market & Geography',
        'D': 'Regulatory',
        'E': 'IP',
        'F': 'Unit Economics',
        'G': 'Market Sizing',
        'H': 'Revenue & Growth',
        'I': 'Customer Contracts',
        'J': 'Expense Plans',
        'K': 'Exit Strategy',
        'L': 'Self-Reported Risks'
      };

      const colors = [
        'rgba(37, 99, 235, 0.7)',
        'rgba(139, 92, 246, 0.7)',
        'rgba(16, 185, 129, 0.7)',
        'rgba(245, 158, 11, 0.7)',
        'rgba(239, 68, 68, 0.7)'
      ];

      const datasets = submissions.slice(0, 5).map((sub, index) => ({
        label: `#${index + 1} - ${sub.startup_name || sub.email}`,
        data: Object.keys(sectionNames).map(key => sub.section_scores[key] || 0),
        backgroundColor: colors[index],
        borderColor: colors[index].replace('0.7', '1'),
        borderWidth: 2,
        borderRadius: 4
      }));

      sectionScoresChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.values(sectionNames),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Section Risk Score'
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    function displayRankings(submissions) {
      const container = document.getElementById('ranking-container');

      if (submissions.length === 0) {
        container.innerHTML = '<p class="text-center text-secondary" style="padding: 2rem;">No submissions to rank yet</p>';
        return;
      }

      const table = `
        <table class="table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Startup Name</th>
              <th>Overall Risk Score</th>
              <th>Risk Band</th>
              <th>Decision</th>
              <th>Submitted</th>
            </tr>
          </thead>
          <tbody>
            ${submissions.map((sub, index) => `
              <tr>
                <td><strong>#${index + 1}</strong></td>
                <td>${sub.startup_name || sub.email}</td>
                <td><strong>${sub.total_risk_score.toFixed(1)}</strong></td>
                <td>${getRiskBadge(sub.risk_band)}</td>
                <td style="max-width: 300px;">${sub.decision}</td>
                <td>${new Date(sub.submitted_at).toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = table;
    }

    function displayKPIComparison(submissions) {
      const container = document.getElementById('kpi-container');

      if (submissions.length === 0) return;

      const kpiNames = {
        kpi_regulatory: 'Regulatory Risk',
        kpi_unit_economics: 'Unit Economics',
        kpi_growth_stability: 'Growth Stability',
        kpi_customer_concentration: 'Customer Concentration',
        kpi_execution_complexity: 'Execution Complexity',
        kpi_exit_clarity: 'Exit Clarity'
      };

      const table = `
        <table class="table">
          <thead>
            <tr>
              <th>Startup</th>
              ${Object.values(kpiNames).map(name => `<th>${name}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${submissions.map(sub => {
        const kpis = sub.kpi_scores;
        return `
                <tr>
                  <td><strong>${sub.startup_name || sub.email}</strong></td>
                  ${Object.keys(kpiNames).map(key => `
                    <td>${kpis[key] ? kpis[key].toFixed(1) : 'N/A'}</td>
                  `).join('')}
                </tr>
              `;
      }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = table;
    }

    function getRiskBadge(band) {
      const badges = {
        'Low Risk': 'badge-success',
        'Medium Risk': 'badge-warning',
        'High Risk': 'badge-danger'
      };
      return `<span class="badge ${badges[band] || 'badge-secondary'}">${band}</span>`;
    }
  </script>
</body>

</html>