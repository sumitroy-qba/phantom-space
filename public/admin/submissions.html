<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submissions - Admin</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/admin/dashboard.html" class="sidebar-logo">
                    <span>üìä</span>
                    <span>Risk Assessment</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Main</div>
                    <a href="/admin/dashboard.html" class="sidebar-link">
                        <span class="sidebar-icon">üè†</span>
                        <span>Overview</span>
                    </a>
                    <a href="/admin/startup-users.html" class="sidebar-link">
                        <span class="sidebar-icon">üë•</span>
                        <span>Startup Users</span>
                    </a>
                    <a href="/admin/submissions.html" class="sidebar-link active">
                        <span class="sidebar-icon">üìÑ</span>
                        <span>Submissions</span>
                    </a>
                    <a href="/admin/compare.html" class="sidebar-link">
                        <span class="sidebar-icon">üìä</span>
                        <span>Compare & Rank</span>
                    </a>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Configuration</div>
                    <a href="/admin/survey-builder.html" class="sidebar-link">
                        <span class="sidebar-icon">‚öôÔ∏è</span>
                        <span>Survey Builder</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <div class="main-content-wrapper">
            <!-- Top Navbar -->
            <header class="top-navbar">
                <div class="navbar-left">
                    <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">Submissions</h2>
                </div>
                <div class="navbar-right">
                    <div class="user-menu">
                        <div class="user-menu-btn">
                            <span id="username-display">Admin</span>
                            <button class="btn btn-sm btn-secondary" id="logout-btn"
                                style="margin-left: 0.5rem;">Logout</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                <p class="text-secondary mb-3">View and analyze all submitted risk assessments</p>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Startup Name</th>
                                    <th>Submitted By</th>
                                    <th>Risk Score</th>
                                    <th>Risk Band</th>
                                    <th>Submitted At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="submissions-table">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">Loading submissions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        // Check authentication
        fetch('/admin/api/check-session')
            .then(res => res.json())
            .then(data => {
                if (!data.authenticated) {
                    window.location.href = '/admin/login.html';
                } else {
                    document.getElementById('username-display').textContent = data.username;
                    loadSubmissions();
                }
            });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch('/admin/api/logout', { method: 'POST' });
            window.location.href = '/admin/login.html';
        });

        async function loadSubmissions() {
            try {
                const response = await fetch('/admin/api/submissions');
                const submissions = await response.json();

                displaySubmissions(submissions);
            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('submissions-table').innerHTML =
                    '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger);">Error loading submissions</td></tr>';
            }
        }

        function displaySubmissions(submissions) {
            const tbody = document.getElementById('submissions-table');

            if (submissions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No submissions found</td></tr>';
                return;
            }

            tbody.innerHTML = submissions.map(sub => {
                const riskBand = sub.total_risk_score <= 33 ? 'Low' : sub.total_risk_score <= 66 ? 'Medium' : 'High';
                const badgeClass = riskBand.toLowerCase();
                const date = new Date(sub.submitted_at).toLocaleString();

                return `
                    <tr>
                        <td><strong>${sub.startup_name || 'Unknown'}</strong></td>
                        <td>${sub.email || 'N/A'}</td>
                        <td style="font-weight: 700; font-size: 1.125rem;">${sub.total_risk_score}</td>
                        <td><span class="risk-badge ${badgeClass}">${riskBand}</span></td>
                        <td>${date}</td>
                        <td>
                            <a href="/admin/submission-details.html?id=${sub.id}" class="btn btn-sm btn-primary">View Details</a>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>

</html>