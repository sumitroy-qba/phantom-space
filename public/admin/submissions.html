<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submissions - Admin</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/admin/dashboard.html" class="sidebar-logo">
                    <span>üìä</span>
                    <span>Risk Assessment</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Main</div>
                    <a href="/admin/dashboard.html" class="sidebar-link">
                        <span class="sidebar-icon">üè†</span>
                        <span>Overview</span>
                    </a>
                    <a href="/admin/startup-users.html" class="sidebar-link">
                        <span class="sidebar-icon">üë•</span>
                        <span>Startup Users</span>
                    </a>
                    <a href="/admin/submissions.html" class="sidebar-link active">
                        <span class="sidebar-icon">üìÑ</span>
                        <span>Submissions</span>
                    </a>
                    <a href="/admin/compare.html" class="sidebar-link">
                        <span class="sidebar-icon">üìä</span>
                        <span>Compare & Rank</span>
                    </a>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Configuration</div>
                    <a href="/admin/survey-builder.html" class="sidebar-link">
                        <span class="sidebar-icon">‚öôÔ∏è</span>
                        <span>Survey Builder</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <div class="main-content-wrapper">
            <!-- Top Navbar -->
            <header class="top-navbar">
                <div class="navbar-left">
                    <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-primary);">Submissions</h2>
                </div>
                <div class="navbar-right">
                    <div class="user-menu">
                        <div class="user-menu-btn">
                            <span id="username-display">Admin</span>
                            <button class="btn btn-sm btn-secondary" id="logout-btn"
                                style="margin-left: 0.5rem;">Logout</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                <p class="text-secondary mb-3">View and analyze all submitted risk assessments</p>

                <!-- Filters -->
                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="filters-container"
                            style="display: flex; gap: 2rem; align-items: flex-end; flex-wrap: wrap;">
                            <!-- Risk Band Filter -->
                            <div style="position: relative;">
                                <label for="filterRiskBand"
                                    style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: var(--text-secondary);">Risk
                                    Band</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <select id="filterRiskBand" class="form-control"
                                        style="min-width: 160px; padding: 0.6rem; border-color: #E5E7EB;">
                                        <option value="">All Bands</option>
                                        <option value="Low">Low Risk</option>
                                        <option value="Medium">Medium Risk</option>
                                        <option value="High">High Risk</option>
                                    </select>
                                    <button id="clearRiskBand" class="btn btn-sm btn-outline-secondary"
                                        style="padding: 0.4rem 0.8rem; font-size: 0.8rem;"
                                        title="Clear Filter">‚úï</button>
                                </div>
                            </div>

                            <!-- Risk Score Range Filter -->
                            <div>
                                <label
                                    style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: var(--text-secondary);">Risk
                                    Score Range</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="number" id="filterMinScore" class="form-control" placeholder="Min"
                                        style="width: 90px; padding: 0.6rem; border-color: #E5E7EB;" min="0" max="100">
                                    <span class="text-secondary" style="font-weight: 500;">-</span>
                                    <input type="number" id="filterMaxScore" class="form-control" placeholder="Max"
                                        style="width: 90px; padding: 0.6rem; border-color: #E5E7EB;" min="0" max="100">
                                    <button id="clearScoreRange" class="btn btn-sm btn-outline-secondary"
                                        style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-left: 0.5rem;"
                                        title="Clear Range">‚úï</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Startup Name</th>
                                    <th>Submitted By</th>
                                    <th>Risk Score</th>
                                    <th>Risk Band</th>
                                    <th>Submitted At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="submissions-table">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">Loading submissions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        // Check authentication
        fetch('/admin/api/check-session')
            .then(res => res.json())
            .then(data => {
                if (!data.authenticated) {
                    window.location.href = '/admin/login.html';
                } else {
                    document.getElementById('username-display').textContent = data.username;
                    loadSubmissions();
                }
            });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch('/admin/api/logout', { method: 'POST' });
            window.location.href = '/admin/login.html';
        });

        let allSubmissions = [];

        async function loadSubmissions() {
            try {
                const response = await fetch('/admin/api/submissions');
                allSubmissions = await response.json();

                // Check for URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const riskBandParam = urlParams.get('riskBand');
                const minScoreParam = urlParams.get('minScore');
                const maxScoreParam = urlParams.get('maxScore');

                if (riskBandParam) {
                    document.getElementById('filterRiskBand').value = riskBandParam;
                }
                if (minScoreParam) {
                    document.getElementById('filterMinScore').value = minScoreParam;
                }
                if (maxScoreParam) {
                    document.getElementById('filterMaxScore').value = maxScoreParam;
                }

                filterSubmissions();

            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('submissions-table').innerHTML =
                    '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger);">Error loading submissions</td></tr>';
            }
        }

        function filterSubmissions() {
            const riskBand = document.getElementById('filterRiskBand').value;
            const minScore = document.getElementById('filterMinScore').value;
            const maxScore = document.getElementById('filterMaxScore').value;

            const filtered = allSubmissions.filter(sub => {
                let matchesBand = true;
                let matchesScore = true;
                const score = sub.total_risk_score;

                // Determine risk band of the submission
                let subBand = 'High';
                if (score <= 33) subBand = 'Low';
                else if (score <= 66) subBand = 'Medium';

                // Filter by Band
                if (riskBand && riskBand !== '') {
                    // Match "Low" with "Low", "Low Risk" with "Low", etc.
                    // The dropdown values are Low, Medium, High.
                    // The calculated subBand is Low, Medium, High.
                    matchesBand = subBand === riskBand;
                }

                // Filter by Score Range
                if (minScore && score < parseFloat(minScore)) matchesScore = false;
                if (maxScore && score > parseFloat(maxScore)) matchesScore = false;

                return matchesBand && matchesScore;
            });

            displaySubmissions(filtered);
        }

        function displaySubmissions(submissions) {
            const tbody = document.getElementById('submissions-table');

            if (submissions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No submissions found matching filters</td></tr>';
                return;
            }

            tbody.innerHTML = submissions.map(sub => {
                const riskBand = sub.total_risk_score <= 33 ? 'Low' : sub.total_risk_score <= 66 ? 'Medium' : 'High';
                const badgeClass = riskBand.toLowerCase();
                const date = new Date(sub.submitted_at).toLocaleString();

                return `
                    <tr>
                        <td><strong>${sub.startup_name || 'Unknown'}</strong></td>
                        <td>${sub.email || 'N/A'}</td>
                        <td style="font-weight: 700; font-size: 1.125rem;">${sub.total_risk_score}</td>
                        <td><span class="risk-badge ${badgeClass}">${riskBand}</span></td>
                        <td>${date}</td>
                        <td>
                            <a href="/admin/submission-details.html?id=${sub.id}" class="btn btn-sm btn-primary">View Details</a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Event Listeners for Filters
        // Event Listeners for Filters
        const filterRiskBand = document.getElementById('filterRiskBand');
        const filterMinScore = document.getElementById('filterMinScore');
        const filterMaxScore = document.getElementById('filterMaxScore');

        function updateFilters() {
            const riskBand = filterRiskBand.value;
            const minScore = filterMinScore.value;
            const maxScore = filterMaxScore.value;

            const url = new URL(window.location);
            if (riskBand) url.searchParams.set('riskBand', riskBand); else url.searchParams.delete('riskBand');
            if (minScore) url.searchParams.set('minScore', minScore); else url.searchParams.delete('minScore');
            if (maxScore) url.searchParams.set('maxScore', maxScore); else url.searchParams.delete('maxScore');

            window.history.pushState({}, '', url);

            filterSubmissions();
        }

        // Auto-apply on change
        filterRiskBand.addEventListener('change', updateFilters);
        filterMinScore.addEventListener('input', updateFilters); // Use input for real-time, or change for on-blur
        filterMaxScore.addEventListener('input', updateFilters);

        // Clear buttons
        document.getElementById('clearRiskBand').addEventListener('click', () => {
            filterRiskBand.value = '';
            updateFilters();
        });

        document.getElementById('clearScoreRange').addEventListener('click', () => {
            filterMinScore.value = '';
            filterMaxScore.value = '';
            updateFilters();
        });
    </script>
</body>

</html>